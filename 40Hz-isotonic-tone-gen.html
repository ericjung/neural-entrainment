<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<title>Neural Entrainment - 40 Hz @ 48 kHz loop</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root { color-scheme: dark; }
  body { background:#000; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
  h1 { margin-top: 0; }
  .row { margin:.75rem 0; display:flex; gap:1rem; align-items:center; flex-wrap:wrap; }
  .tag { padding:.25rem .5rem; border:1px solid #444; border-radius:.4rem; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  label { display:inline-flex; align-items:center; gap:.5rem; }
  input[type="number"] { width: 7rem; padding:.35rem .5rem; border-radius:.35rem; border:1px solid #444; background:#111; color:#fff; }
  button { padding:.5rem .9rem; border-radius:.5rem; border:1px solid #444; background:#111; color:#fff; }
  button:hover:not(:disabled) { background:#1a1a1a; }
  button:disabled { opacity:.6; cursor:not-allowed; }
  small { color:#aaa; }
  #meterWrap { width: 420px; }
  #meter { width: 100%; height: 20px; display:block; background:#111; border:1px solid #444; border-radius:6px; }
  #meterLabel { font-size:.9rem; color:#bbb; }
</style>

<h1>Neural Entrainment - 40 Hz @ 48 kHz loop</h1>
<h3>Pure 40 Hz sine loop at 48 kHz, sample-accurate, no carrier, no compressor</h3>

<div class="row">
  <span class="tag">Sample rate: <strong>48,000 Hz</strong></span>
  <span class="tag">Frequency: <strong>40 Hz</strong></span>
  <span class="tag">Duration (buffer): <strong>1.000 s</strong></span>
</div>

<div class="row">
  <!-- Output gain for the 40 Hz tone. Clamped ≤ 1.0 to prevent clipping. -->
  <label>Amplitude (40 Hz, output gain). Above 1.0 causes clipping.
    <input id="amp40" type="number" value="0.8" min="0" max="1.0" step="0.01" />
  </label>
</div>

<div class="row">
  <button id="play">Play (loop)</button>
  <button id="stop">Stop</button>
  <small>Tip: for more loudness, keep gain ≤ 1.0 here and raise your system volume.</small>
</div>

<div class="row" id="meterWrap">
  <canvas id="meter" width="420" height="20"></canvas>
  <span id="meterLabel">Output level</span>
</div>

<script>
/*
  Buffer length is hard-coded to 1.000 s.
  IMPORTANT: To avoid clicks at the loop boundary, the buffer duration must be
  an integer multiple of the cycle length (1/40 s = 0.025 s), e.g. 1 s, 2.5 s, 10 s, etc.

  DESIGN:
  - 40 Hz tone is synthesized at amplitude = 1.0 (full-scale, clean).
  - "Amplitude (40 Hz)" is POST-GAIN via GainNode, clamped ≤ 1.0.
  - A simple RMS level meter shows post-gain output in real time.
*/

const FIXED_SAMPLE_RATE = 48000;  // 48 kHz (requested)
const FIXED_DURATION_S  = 1.0;    // 1.000 s
const FREQ_MAIN_HZ      = 40;     // 40 Hz entrainment target

let ctx = null;
let src40 = null, gain40 = null, analyser = null;

const $play = document.getElementById('play');
const $stop = document.getElementById('stop');
const $amp40 = document.getElementById('amp40');

const meterCanvas = document.getElementById('meter');
const mctx = meterCanvas.getContext('2d');
let meterRAF = null;

/** Ensure an AudioContext exists, requesting 48 kHz (browser may override) */
async function ensureCtx() {
  if (!ctx) {
    const AC = window.AudioContext || window.webkitAudioContext;
    ctx = new AC({ sampleRate: FIXED_SAMPLE_RATE });

    // Post-gain node (volume control)
    gain40 = ctx.createGain();

    // Analyser to visualize post-gain output
    analyser = ctx.createAnalyser();
    analyser.fftSize = 2048;          // fine for RMS
    analyser.smoothingTimeConstant = 0.8;

    // Split post-gain to analyser and destination
    gain40.connect(analyser);
    gain40.connect(ctx.destination);
  }
  if (ctx.state === 'suspended') await ctx.resume();
  return ctx;
}

/** Generate a pure 40 Hz sine at amplitude EXACTLY 1.0 */
function makeBuffer40Hz() {
  const rate = ctx.sampleRate;
  const n = Math.floor(FIXED_DURATION_S * rate);
  const data = new Float32Array(n);
  const w = 2 * Math.PI * FREQ_MAIN_HZ;
  for (let i = 0; i < n;
