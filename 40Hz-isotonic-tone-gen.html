<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Neural Entrainment - 40 Hz loop</title>
<meta name="theme-color" content="#0b0f14" />
<style>
  :root { --bg:#0b0f14; --panel:#0f141b; --fg:#e6f1ff; --muted:#93a4bb; --border:#1e2a36; }
  html,body { height:100%; }
  body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--fg); display:grid; place-items:center; }
  main { width:min(760px,94vw); padding:22px; background:var(--panel); border:1px solid var(--border); border-radius:14px; box-shadow:0 6px 30px rgba(0,0,0,.35); }
  h1 { margin:0 0 12px; font-size:20px; }
  .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin:10px 0; }
  label { color:var(--muted); font-size:14px; }
  button, input[type="range"] { background:#131a22; color:var(--fg); border:1px solid var(--border); border-radius:10px; }
  button { padding:10px 14px; font-weight:600; cursor:pointer; }
  input[type="range"] { height:36px; padding:0 6px; }
  .val { min-width:74px; text-align:right; color:#cfe3ff; font-variant-numeric:tabular-nums; }
  .hint { color:var(--muted); font-size:12px; margin-top:8px; line-height:1.4; }
  .timer {
    font-size:28px; font-variant-numeric:tabular-nums; letter-spacing:0.02em;
    padding:6px 10px; border:1px solid var(--border); border-radius:10px; min-width:140px; text-align:center;
    background:#111824;
  }
</style>
</head>
<body>
<main>
  <h1>Neural Entrainment - 40 Hz loop</h1>

  <div class="row">
    <button id="playBtn">Play (Loop)</button>
    <button id="stopBtn">Stop</button>

    <div class="timer" id="timer" aria-live="polite">00:00:00</div>
    <button id="resetTimerBtn" title="Reset timer to 00:00:00">Reset Timer</button>
  </div>

  <div class="row">
    <label for="gain">Volume</label>
    <input id="gain" type="range" min="0" max="1" step="0.01" value="0.15" />
    <div class="val" id="gainVal">0.15</div>
  </div>

  <div class="hint">
    Tap <b>Play (Loop)</b> once. Audio should continue while you switch tabs/apps or lock the screen.<br>
    Works offline after your first visit. Can also be added to the iPhone home screen.  
    Use Safari's Share â†’ Add to Home Screen (must be Safari I think, not another web browser)
  </div>
</main>

<script>
/* --- Service Worker + Manifest (inline) --- */
(async () => {
  if (!('serviceWorker' in navigator)) return;
  const manifest = {
    name: "Neural Entrainment - 40 Hz loop",
    short_name: "40Hz Loop",
    start_url: location.pathname + location.search,
    display: "standalone",
    background_color: "#0b0f14",
    theme_color: "#0b0f14",
    icons: []
  };
  const manifestBlob = new Blob([JSON.stringify(manifest)], { type: "application/manifest+json" });
  const manifestURL = URL.createObjectURL(manifestBlob);
  const link = document.createElement('link');
  link.rel = 'manifest';
  link.href = manifestURL;
  document.head.appendChild(link);

  const CACHE = "tone-v1";
  const swCode = `
    const CACHE = "${CACHE}";
    self.addEventListener("install", (e) => { self.skipWaiting(); });
    self.addEventListener("activate", (e) => {
      e.waitUntil((async () => {
        const keys = await caches.keys();
        await Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)));
        await self.clients.claim();
      })());
    });
    self.addEventListener("fetch", (e) => {
      const req = e.request;
      if (req.method !== "GET") return;
      e.respondWith((async () => {
        const cache = await caches.open(CACHE);
        const cached = await cache.match(req);
        if (cached) return cached;
        try {
          const resp = await fetch(req);
          if (resp.ok && (req.mode === "navigate" || req.headers.get("accept")?.includes("text/html") || req.destination === "document")) {
            cache.put(req, resp.clone());
          }
          return resp;
        } catch {
          const fallback = await cache.match(self.registration.scope);
          if (fallback) return fallback;
          return new Response("<h1>Offline</h1><p>This app is cached for offline use after your first visit.</p>", { headers: { "Content-Type": "text/html" }});
        }
      })());
    });
  `;
  const swBlob = new Blob([swCode], { type: "text/javascript" });
  const swURL = URL.createObjectURL(swBlob);
  try { await navigator.serviceWorker.register(swURL, { scope: "./" }); } catch {}
})();

/* --- Audio setup (fixed 40 Hz) --- */
(() => {
  let ctx, osc, gainNode, mediaDest, audioEl;
  let running = false;

  const state = { freq: 40.0, gain: 0.15 };

  const playBtn = document.getElementById('playBtn');
  const stopBtn = document.getElementById('stopBtn');
  const gainSlider = document.getElementById('gain');
  const gainVal = document.getElementById('gainVal');

  function setupAudio() {
    if (ctx) return;
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    gainNode = ctx.createGain();
    gainNode.gain.value = state.gain;
    gainNode.connect(ctx.destination);
    mediaDest = ctx.createMediaStreamDestination();
    gainNode.connect(mediaDest);
    osc = ctx.createOscillator();
    osc.type = 'sine';
    osc.frequency.value = state.freq; // always 40 Hz
    osc.connect(gainNode);
    audioEl = new Audio();
    audioEl.playsInline = true;
    audioEl.srcObject = mediaDest.stream;
    if ('mediaSession' in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: `Neural Entrainment - 40 Hz loop`,
        artist: 'Background Tone',
        album: 'Session'
      });
      navigator.mediaSession.setActionHandler('play', async () => { try { await audioEl.play(); } catch {} if (ctx.state === 'suspended') await ctx.resume(); });
      navigator.mediaSession.setActionHandler('pause', () => { audioEl.pause(); });
    }
  }

  async function startAudio() {
    setupAudio();
    if (ctx.state === 'suspended') await ctx.resume();
    try { await audioEl.play(); } catch {}
    try { osc.start(); } catch {}
    running = true;
  }

  async function stopAudio() {
    if (!ctx) return;
    audioEl.pause();
    try { osc.stop(); } catch {}
    osc = ctx.createOscillator();
    osc.type = 'sine';
    osc.frequency.value = state.freq;
    osc.connect(gainNode);
    running = false;
  }

  playBtn.addEventListener('click', async () => {
    if (!running) { await startAudio(); startTimer(); }
  });
  stopBtn.addEventListener('click', async () => {
    if (running) { await stopAudio(); stopTimer(); }
  });

  gainSlider.addEventListener('input', () => {
    state.gain = +gainSlider.value;
    gainVal.textContent = state.gain.toFixed(2);
    if (gainNode && ctx) gainNode.gain.setTargetAtTime(state.gain, ctx.currentTime, 0.02);
  });

  document.addEventListener('visibilitychange', async () => {
    if (document.visibilityState === 'visible' && ctx && ctx.state === 'suspended') {
      try { await ctx.resume(); } catch {}
    }
  });

  /* --- Timer --- */
  const timerEl = document.getElementById('timer');
  const resetBtn = document.getElementById('resetTimerBtn');
  let timerInterval = null;
  let elapsedSeconds = 0;

  function formatHMS(s) {
    const hrs = Math.floor(s / 3600);
    const mins = Math.floor((s % 3600) / 60);
    const secs = s % 60;
    const pad = (n) => n.toString().padStart(2, '0');
    return `${pad(hrs)}:${pad(mins)}:${pad(secs)}`;
  }
  function renderTimer() { timerEl.textContent = formatHMS(elapsedSeconds); }
  function startTimer() {
    if (timerInterval) return;
    timerInterval = setInterval(() => { elapsedSeconds += 1; renderTimer(); }, 1000);
  }
  function stopTimer() { clearInterval(timerInterval); timerInterval = null; }
  function resetTimer() { elapsedSeconds = 0; renderTimer(); }
  resetBtn.addEventListener('click', resetTimer);
  renderTimer();
})();
</script>
</body>
</html>
