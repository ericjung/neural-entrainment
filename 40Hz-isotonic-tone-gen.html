<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Neural Entrainment - 40 Hz loop</title>
<meta name="theme-color" content="#0b0f14" />
<style>
  :root { --bg:#0b0f14; --panel:#0f141b; --fg:#e6f1ff; --muted:#93a4bb; --border:#1e2a36; --pill:#0f1f2d; --ok:#23c55e; --warn:#60a5fa; }
  html,body { height:100%; }
  body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--fg); display:grid; place-items:center; }
  main { width:min(760px,94vw); padding:22px; background:var(--panel); border:1px solid var(--border); border-radius:14px; box-shadow:0 6px 30px rgba(0,0,0,.35); text-align:center; }
  h1 { margin:0 0 12px; font-size:20px; }
  .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin:10px 0; justify-content:center; }
  button, input[type="range"] { background:#131a22; color:var(--fg); border:1px solid var(--border); border-radius:10px; }
  button { padding:10px 14px; font-weight:600; cursor:pointer; }
  input[type="range"] { height:36px; padding:0 6px; }
  .val { min-width:74px; text-align:right; color:#cfe3ff; font-variant-numeric:tabular-nums; }
  .timer { font-size:28px; font-variant-numeric:tabular-nums; padding:6px 10px; border:1px solid var(--border); border-radius:10px; min-width:140px; text-align:center; background:#111824; }
  .status { display:inline-flex; align-items:center; gap:.5ch; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--pill); color:var(--muted); font-size:14px; }
  .dot { width:8px; height:8px; border-radius:50%; background:#6b7280; display:inline-block; }
  .dot.on { background:var(--ok); }
  .dot.am { background:var(--warn); }
  audio { display:none; }
</style>
</head>
<body>
<main>
  <h1>Neural Entrainment</h1>

  <div class="row">
    <button id="playFileBtn">Play Continuous 40Hz Sine (file)</button>
    <button id="playAMBtn">Play 10kHz pulsed at 40Hz</button>
    <button id="stopBtn">Stop</button>
    <div class="timer" id="timer" aria-live="polite">00:00:00</div>
    <button id="resetTimerBtn">Reset Timer</button>
  </div>

  <div class="row" aria-live="polite">
    <div id="status" class="status">
      <span class="dot" id="statusDot" aria-hidden="true"></span>
      <span id="statusText">Stopped</span>
    </div>
  </div>

  <div class="row">
    <label for="gain">Volume</label>
    <input id="gain" type="range" min="0" max="1" step="0.01" value="0.15" />
    <div class="val" id="gainVal">0.15</div>
  </div>

  <!-- #1: external audio file, looped -->
  <audio id="loopAudio" src="40hz-continuous-sine.wav" preload="auto" loop playsinline></audio>
</main>

<script>
(() => {
  const playFileBtn = document.getElementById('playFileBtn');
  const playAMBtn   = document.getElementById('playAMBtn');
  const stopBtn     = document.getElementById('stopBtn');
  const gainSlider  = document.getElementById('gain');
  const gainVal     = document.getElementById('gainVal');
  const fileEl      = document.getElementById('loopAudio');

  const statusText  = document.getElementById('statusText');
  const statusDot   = document.getElementById('statusDot');

  let ctx = null;
  let carrierOsc = null, modOsc = null, modOffset = null, masterGain = null;
  let runningMode = null; // "file" | "am" | null

  function ensureCtx() {
    if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
  }

  function setStatus(mode) {
    // Reset classes
    statusDot.classList.remove('on', 'am');
    if (mode === 'file') {
      statusText.textContent = 'Now playing: 40Hz Sine (file loop)';
      statusDot.classList.add('on');
    } else if (mode === 'am') {
      statusText.textContent = 'Now playing: 10kHz tone pulsed @ 40Hz';
      statusDot.classList.add('am');
    } else {
      statusText.textContent = 'Stopped';
    }
  }

  async function stopAll() {
    // stop Web Audio (#2)
    if (carrierOsc) { try { carrierOsc.stop(); } catch {} carrierOsc.disconnect(); carrierOsc = null; }
    if (modOsc) { try { modOsc.stop(); } catch {} modOsc.disconnect(); modOsc = null; }
    if (modOffset) { try { modOffset.stop(); } catch {} modOffset.disconnect(); modOffset = null; }
    if (masterGain) { try { masterGain.disconnect(); } catch {} masterGain = null; }

    // stop file (#1)
    try { fileEl.pause(); } catch {}
    runningMode = null;
    setStatus(null);
    stopTimer();
  }

  async function playFileLoop() {
    await stopAll();                    // ensure exclusivity
    runningMode = "file";
    fileEl.volume = +gainSlider.value;
    await fileEl.play();
    setStatus('file');
    startTimer();
  }

  async function playPulsedAM() {
    await stopAll();                    // ensure exclusivity
    runningMode = "am";
    ensureCtx();
    if (ctx.state === 'suspended') await ctx.resume();

    masterGain = ctx.createGain();
    masterGain.gain.value = +gainSlider.value;

    // Carrier: 10 kHz sine
    carrierOsc = ctx.createOscillator();
    carrierOsc.type = 'sine';
    carrierOsc.frequency.value = 10000;

    // Modulator: 40 Hz square -> scale [-1,1] -> [0,1]
    modOsc = ctx.createOscillator();
    modOsc.type = 'square';
    modOsc.frequency.value = 40;

    const modGain = ctx.createGain();  // scale to 0.5
    modGain.gain.value = 0.5;
    modOffset = ctx.createConstantSource(); // offset 0.5
    modOffset.offset.value = 0.5;

    const carrierGain = ctx.createGain();
    carrierGain.gain.value = 0;

    // Wiring: (square*0.5 + 0.5) -> carrierGain.gain
    modOsc.connect(modGain).connect(carrierGain.gain);
    modOffset.connect(carrierGain.gain);

    carrierOsc.connect(carrierGain).connect(masterGain).connect(ctx.destination);

    modOffset.start();
    modOsc.start();
    carrierOsc.start();
    setStatus('am');
    startTimer();
  }

  playFileBtn.addEventListener('click', playFileLoop);
  playAMBtn.addEventListener('click', playPulsedAM);
  stopBtn.addEventListener('click', stopAll);

  // Volume handling
  gainSlider.addEventListener('input', () => {
    const v = +gainSlider.value;
    gainVal.textContent = v.toFixed(2);
    if (runningMode === "file") fileEl.volume = v;
    else if (runningMode === "am" && masterGain && ctx) masterGain.gain.setTargetAtTime(v, ctx.currentTime, 0.02);
  });

  // Timer
  const timerEl = document.getElementById('timer');
  const resetBtn = document.getElementById('resetTimerBtn');
  let timerInterval = null, elapsedSeconds = 0;
  const pad = n => n.toString().padStart(2,'0');
  function formatHMS(s){return `${pad(Math.floor(s/3600))}:${pad(Math.floor((s%3600)/60))}:${pad(s%60)}`;}
  function renderTimer(){timerEl.textContent = formatHMS(elapsedSeconds);}
  function startTimer(){ if (timerInterval) return; timerInterval = setInterval(()=>{elapsedSeconds++; renderTimer();},1000);}
  function stopTimer(){ clearInterval(timerInterval); timerInterval=null;}
  function resetTimer(){ elapsedSeconds=0; renderTimer();}
  resetBtn.addEventListener('click', resetTimer);
  renderTimer();
})();
</script>
</body>
</html>
