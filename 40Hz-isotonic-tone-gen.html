<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<title>Neural Entrainment - 40 Hz @ 48 kHz loop</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root { color-scheme: dark; }
  body { background:#000; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
  h1 { margin-top: 0; }
  .row { margin:.5rem 0; display:flex; gap:1rem; align-items: center; flex-wrap: wrap; }
  .tag { padding:.25rem .5rem; border:1px solid #444; border-radius:.4rem; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  label { display:inline-flex; align-items:center; gap:.5rem; }
  input[type="number"] { width: 7rem; padding:.35rem .5rem; border-radius:.35rem; border:1px solid #444; background:#111; color:#fff; }
  input[type="checkbox"] { transform: scale(1.1); }
  button { padding:.5rem .9rem; border-radius:.5rem; border:1px solid #444; background:#111; color:#fff; }
  button:hover:not(:disabled) { background:#1a1a1a; }
  button:disabled { opacity:.6; cursor:not-allowed; }
  small { color:#aaa; }
</style>

<h1>Neural Entrainment - 40 Hz @ 48 kHz loop</h1>

<div class="row">
  <span class="tag">Sample rate: <strong>48,000 Hz</strong></span>
  <span class="tag">Frequency: <strong>40 Hz</strong></span>
  <span class="tag">Duration (buffer): <strong>1.000 s</strong></span>
</div>

<div class="row">
  <label>Amplitude (40 Hz)
    <input id="amp40" type="number" value="1.5" min="0" max="10" step="0.05" />
  </label>
</div>

<div class="row">
  <label><input id="useCarrier" type="checkbox"> Enable 200 Hz AM carrier (modulated at 40 Hz)</label>
  <label>Amplitude (200 Hz carrier)
    <input id="amp200" type="number" value="0.6" min="0" max="10" step="0.05" />
  </label>
</div>

<div class="row">
  <button id="play">Play (loop)</button>
  <button id="stop">Stop</button>
  <small>Play is disabled while looping; press Stop to re-enable.</small>
</div>

<script>
/*
  Buffer length is hard-coded to 1.000 s.
  IMPORTANT: To avoid clicks at the loop boundary, the buffer duration must be
  an integer multiple of the cycle length (1/40 s = 0.025 s), e.g. 1 s, 2.5 s, 10 s, etc.
*/

const FIXED_SAMPLE_RATE = 48000;  // 48 kHz (requested)
const FIXED_DURATION_S  = 1.0;    // 1.000 s (exact)
const FREQ_MAIN_HZ      = 40;     // 40 Hz (entrainment target)
const FREQ_CARRIER_HZ   = 200;    // 200 Hz optional AM carrier

let ctx = null, buffer = null, src = null;
const $play = document.getElementById('play');
const $stop = document.getElementById('stop');
const $amp40 = document.getElementById('amp40');
const $amp200 = document.getElementById('amp200');
const $useCarrier = document.getElementById('useCarrier');

/** Ensure an AudioContext exists, requesting 48 kHz (browser may override) */
async function ensureCtx() {
  if (!ctx) {
    const AC = window.AudioContext || window.webkitAudioContext;
    ctx = new AC({ sampleRate: FIXED_SAMPLE_RATE });
  }
  if (ctx.state === 'suspended') await ctx.resume();
  return ctx;
}

/** Generate Float32 buffer:
 *  - Pure 40 Hz sine (always)
 *  - Optional 200 Hz carrier, amplitude-modulated by 40 Hz: (0.5 + 0.5*sin(40Hz*t))
 */
function generateFloat32(sampleRate, durationSec, amp40, useCarrier, amp200) {
  const numSamples = Math.floor(durationSec * sampleRate); // [0, 1s)
  const out = new Float32Array(numSamples);

  const w40 = 2 * Math.PI * FREQ_MAIN_HZ;
  const w200 = 2 * Math.PI * FREQ_CARRIER_HZ;

  for (let i = 0; i < numSamples; i++) {
    const t = i / sampleRate;

    // Base 40 Hz component (entrainment)
    let v = Math.sin(w40 * t) * amp40;

    // Optional 200 Hz AM carrier, envelope at 40 Hz (kept â‰¥0 with 0.5+0.5*sin)
    if (useCarrier) {
      const env = 0.5 + 0.5 * Math.sin(w40 * t);
      v += Math.sin(w200 * t) * (amp200 * env);
    }

    // Clamp to [-1, 1] to avoid clipping
    if (v > 1) v = 1; else if (v < -1) v = -1;
    out[i] = v;
  }
  return out;
}

/** Build (or rebuild) the AudioBuffer from current UI values */
async function buildBuffer() {
  await ensureCtx();
  const rate = ctx.sampleRate; // actual rate (may differ from 48k on some devices)
  const amp40 = parseFloat($amp40.value);
  const amp200 = parseFloat($amp200.value);
  const useCarrier = $useCarrier.checked;

  const samples = generateFloat32(rate, FIXED_DURATION_S, amp40, useCarrier, amp200);
  buffer = ctx.createBuffer(1, samples.length, rate);
  buffer.getChannelData(0).set(samples);
}

/** Start gapless looping; prevent multiple plays until stopped */
async function playLoop() {
  if (src) return;              // already playing
  await buildBuffer();          // rebuild from current amplitudes/settings

  src = ctx.createBufferSource();
  src.buffer = buffer;
  src.loop = true;              // sample-accurate looping
  src.loopStart = 0;
  src.loopEnd = buffer.duration;
  src.connect(ctx.destination);
  src.start();

  $play.disabled = true;
  src.onended = () => { src = null; $play.disabled = false; };
}

/** Stop playback and re-enable Play */
function stop() {
  if (src) {
    try { src.stop(); } catch(_) {}
    try { src.disconnect(); } catch(_) {}
    src = null;
  }
  $play.disabled = false;
}

$play.onclick = async () => {
  await ensureCtx();
  if (ctx.state === 'suspended') await ctx.resume();
  playLoop();
};
$stop.onclick = stop;
</script>
</html>
